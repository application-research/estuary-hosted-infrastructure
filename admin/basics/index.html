
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../about/">
      
      
        <link rel="next" href="proxmaas/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.4">
    
    
      
        <title>Basics - Filecoin Data Infrastructure</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0e669242.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#basics" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Filecoin Data Infrastructure" class="md-header__button md-logo" aria-label="Filecoin Data Infrastructure" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Filecoin Data Infrastructure
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Basics
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  Basics

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../databases/" class="md-tabs__link">
        
  
    
  
  Databases

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../services/" class="md-tabs__link">
        
  
    
  
  Services

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../kubernetes/" class="md-tabs__link">
        
  
    
  
  Kubernetes

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../rescue/" class="md-tabs__link">
        
  
    
  
  Rescue

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../storage/" class="md-tabs__link">
        
  
    
  
  Storage

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../tls/" class="md-tabs__link">
        
  
    
  
  TLS

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../guides/" class="md-tabs__link">
          
  
  Guides

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Filecoin Data Infrastructure" class="md-nav__button md-logo" aria-label="Filecoin Data Infrastructure" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    Filecoin Data Infrastructure
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Basics
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Basics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Basics
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Basics
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#proxmox" class="md-nav__link">
    Proxmox
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dns" class="md-nav__link">
    DNS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dhcp" class="md-nav__link">
    DHCP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#booting-machines-normally" class="md-nav__link">
    Booting machines (normally)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-deleting-and-managing-machines-and-machine-definitions" class="md-nav__link">
    Creating, deleting and managing machines and machine definitions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-and-logging" class="md-nav__link">
    Monitoring and Logging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backups" class="md-nav__link">
    Backups
  </a>
  
    <nav class="md-nav" aria-label="Backups">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wal-g-kubernetes-via-garagehq" class="md-nav__link">
    WAL-G @ Kubernetes [via GarageHQ]
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pgbackrest" class="md-nav__link">
    pgBackRest
  </a>
  
    <nav class="md-nav" aria-label="pgBackRest">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checking-on-pgbackrest" class="md-nav__link">
    Checking on pgBackRest
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-patching" class="md-nav__link">
    Security &amp; Patching
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="proxmaas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ProxMAAS
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../databases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Databases
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Services
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../rescue/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rescue
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Storage
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../tls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TLS
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../guides/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../guides/01-diagnosing-pacemaker-clusters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Diagnosing Pacemaker clusters including Prod HAProxy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../guides/02-rebalancing-ceph-osds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ceph: Rebalancing Ceph OSDs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../guides/03-stuck-rook-volumes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes: Fixing stuck Rook.io volumes which are preventing containers from starting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#proxmox" class="md-nav__link">
    Proxmox
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dns" class="md-nav__link">
    DNS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dhcp" class="md-nav__link">
    DHCP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#booting-machines-normally" class="md-nav__link">
    Booting machines (normally)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-deleting-and-managing-machines-and-machine-definitions" class="md-nav__link">
    Creating, deleting and managing machines and machine definitions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-and-logging" class="md-nav__link">
    Monitoring and Logging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backups" class="md-nav__link">
    Backups
  </a>
  
    <nav class="md-nav" aria-label="Backups">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wal-g-kubernetes-via-garagehq" class="md-nav__link">
    WAL-G @ Kubernetes [via GarageHQ]
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pgbackrest" class="md-nav__link">
    pgBackRest
  </a>
  
    <nav class="md-nav" aria-label="pgBackRest">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checking-on-pgbackrest" class="md-nav__link">
    Checking on pgBackRest
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-patching" class="md-nav__link">
    Security &amp; Patching
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="basics">Basics</h1>
<h2 id="proxmox">Proxmox</h2>
<p>Proxmox is accessible at <a href="">https://proxmox.estuary.tech:8006</a> using <a href="https://start.1password.com/open/i?a=4XNRW7JPXZEI7C7CEIAF27VTSQ&amp;h=my.1password.com&amp;i=i2yft7dcslm5trfq2t7taognuy&amp;v=ki4skn3vacuvcqz3bcw532weou">these credentials</a></p>
<p>It provides a single-pane-of-glass view of everything that powers FDI, and should be considered the "first port of call" for most troubleshooting.</p>
<p>Within Proxmox, you can stop, start and reboot VMs, as well as migrate them with zero functional downtime between physical hosts, and access the "physical" console of each virtual machine (in other words, attach a monitor, keyboard and mouse to a virtual machine and diagnose what's happening with it).</p>
<p>Behind the scenes, <a href="">https://proxmox.estuary.tech:8006</a> is powered by the physical node Vega. If Vega is down, you can access the other nodes - try <a href="">https://10.24.0.202:8006</a>, <a href="">https://10.24.0.203:8006</a> etc.</p>
<h2 id="dns">DNS</h2>
<p>Our DNS is powered by Technitium DNS, and the machines prod-dns01, prod-dns02, prod-dns03.</p>
<p>These DNS servers are at 10.24.0.51, 10.24.0.52, 10.24.0.53 respectively.</p>
<p>Netbird (which you'll usually use to stay connected to FDI) automatically sets your machine to use these DNS servers so you can access internal resources.</p>
<h2 id="dhcp">DHCP</h2>
<p>Most core machines do not use DHCP for their addresses, but some do. DHCP is dependent on MAAS - Metal as a Service - which is an Estuary Bootstrap service. It runs primarily on prod-ebi-maas01.</p>
<h2 id="booting-machines-normally">Booting machines (normally)</h2>
<p>To start a machine, use Proxmox to start it. If it's stuck, check the console and try and look for clues as to why it is not booting. If no machines are booting (or if many machines are not booting) check Ceph's health in the Proxmox interface and make sure it's healthy.</p>
<h2 id="creating-deleting-and-managing-machines-and-machine-definitions">Creating, deleting and managing machines and machine definitions</h2>
<p>From time to time, it's necessary to create new virtual machines. You can do this easily using the ProxMAAS repo and Vega.</p>
<ul>
<li>Check out the <a href="https://github.com/application-research/ehi-proxmaas">ehi-proxmaas</a> repo somewhere you can work on it.</li>
<li>Within the ehi-proxmaas project, look under <code>vars/production-ehi</code> for the <strong>machine definitions</strong> used to spawn machines.</li>
<li>Create a machine definition</li>
<li>Run the spawn.yml ansible playbook against that machine definition</li>
</ul>
<p>For further details and the actual commands necessary, consult <a href="proxmaas/">the ProxMAAS documentation</a>. </p>
<p>To spawn machines using ProxMAAS using Vega (one of the Proxmox nodes), ssh to root@vega.estuary.tech, and <code>cd ehi-proxmaas</code>. </p>
<p>To set up a local machine to be able to spawn machines, make sure Netbird is installed, then copy <code>vars/secrets.yml</code> from <code>root@vega.estuary.tech:/root/ehi-proxmaas/vars/secrets.yml</code> to your local copy of the repository, making sure to avoid committing the secrets.</p>
<h2 id="monitoring-and-logging">Monitoring and Logging</h2>
<p>There are a number of things that need monitoring throughout the infrastructure. We have various tools for this purpose. Here's a few of them:</p>
<ul>
<li>
<p>Our <a href="https://monitoring.estuary.tech">centralised monitoring solution</a> is provided by CheckMK Enterprise. A VM hosted on Vultr Cloud lives outside the infrastructure and monitors all of our hosts for issues, everything from dropped packets to disks filling and services not working. You can find the login for CheckMK <a href="https://start.1password.com/open/i?a=4XNRW7JPXZEI7C7CEIAF27VTSQ&amp;h=my.1password.com&amp;i=o4oxrarr4tttbsz5ql2a3wxnpq&amp;v=ki4skn3vacuvcqz3bcw532weou">in the password manager</a>.</p>
</li>
<li>
<p>The <a href="http://mfsmaster.estuary.tech:9425">MooseFS CGI monitor</a> allows us to keep an eye on MooseFS and should be checked frequently for warnings and error messages and dead disks and such. Efforts are underway to integrate information from the MooseFS API into CheckMK and open source those checks.</p>
</li>
<li>
<p>The <a href="https://proxmox.estuary.tech:8006/#v1:0:=node%2Faltair:4:38::::::38">Ceph dashboard</a> allows us to keep an eye on Ceph and its health, which should be tended to carefully as Ceph underpins <strong><em>all VMs and all workloads running on FDI</em></strong></p>
</li>
<li>
<p><a href="https://argocd.estuary.tech">ArgoCD</a> provides a view into Customer Provisioned Infrastructure (Phosphophyllite), and can be used to see at a glance whether any customers' Kubernetes resources appear "out of sync" with what they should be, which could indicate problems.</p>
</li>
</ul>
<h2 id="backups">Backups</h2>
<p>There are two core backup services that run in FDI at the moment.</p>
<p>These are:</p>
<ul>
<li>pgBackRest @ prod-db-backup01 (for PostgreSQLs running as VMs)</li>
<li>WAL-G @ Kubernetes [via GarageHQ] (for PostgreSQLs running as Kubernetes pods)</li>
</ul>
<h3 id="wal-g-kubernetes-via-garagehq">WAL-G @ Kubernetes [via GarageHQ]</h3>
<p>We run WAL-G to backup all PostgreSQL databases running in Kubernetes. It runs inside the <code>postgres</code> containers inside each PostgreSQL pod.</p>
<p>It backs up to GarageHQ using the <code>postgresql-backups</code> key pair and the https://s3.estuary.tech endpoint.</p>
<p>In order to check the status of backups for a particular cluster, find a pod within that cluster in Rancher, select the (⋮) and click <code>&gt; Execute Shell</code> to get a shell inside the container, then run the following command inside it:
<div class="highlight"><pre><span></span><code>envdir &quot;/run/etc/wal-e.d/env&quot; wal-g backup-list
</code></pre></div></p>
<p>You should see something like this, with recent backups listed.
<div class="highlight"><pre><span></span><code>root@estuary-api-0:/home/postgres# envdir &quot;/run/etc/wal-e.d/env&quot; wal-g backup-list
name                          modified             wal_segment_backup_start
base_0000001A00001E510000000E 2023-07-06T11:29:59Z 0000001A00001E510000000E
base_0000001A00001E510000005C 2023-07-07T10:33:08Z 0000001A00001E510000005C
base_0000001B00001E51000000A0 2023-07-08T09:31:31Z 0000001B00001E51000000A0
base_0000001B00001E51000000D5 2023-07-09T10:26:17Z 0000001B00001E51000000D5
base_0000001B00001E520000000C 2023-07-10T11:20:18Z 0000001B00001E520000000C
base_0000001B00001E5200000044 2023-07-11T09:16:29Z 0000001B00001E5200000044
</code></pre></div></p>
<h3 id="pgbackrest">pgBackRest</h3>
<p>pgBackRest is currently set up to backup the EHI PostgreSQL cluster. It lives on <code>prod-db-backup01.estuary.tech</code>, and must remain functional. If the pgBackRest repo server (prod-db-backup01) is down, PostgreSQL has nowhere to archive WAL logs to and will collect them indefinitely, causing an eventual out-of-disk-space condition which will take down the EHI PostgreSQL cluster.</p>
<p>It currently backs up to Ceph, and depends on an external Ceph backup for backups to remain 100% safe.</p>
<div class="admonition danger">
<p class="admonition-title">That bears repeating!</p>
<p>pgBackRest being down or non-functional means the EHI database - which EstuaryV2 depends on heavily - will eventually run out of space and stop.</p>
</div>
<h4 id="checking-on-pgbackrest">Checking on pgBackRest</h4>
<p>There are two relevant commands for pgBackRest - <code>info</code> and <code>check</code>.</p>
<p>Check ensures that WAL archiving is working and sane, which is critical to backups working and continuing to work. Here's how you run it:
<div class="highlight"><pre><span></span><code>ubuntu@prod-db-backup01:~$ sudo -u pgbackrest pgbackrest --stanza=fdi_main --log-level-console=info check
2023-07-12 17:04:38.783 P00   INFO: check command begin 2.46: --exec-id=128661-f4c4ef14 --log-level-console=info --pg1-host=prod-ehi-db01.estuary.tech --pg2-host=prod-ehi-db02.estuary.tech --pg3-host=prod-ehi-db03.estuary.tech --pg1-path=/var/lib/postgresql/14/prod_ehi_db/ --pg2-path=/var/lib/postgresql/14/prod_ehi_db/ --pg3-path=/var/lib/postgresql/14/prod_ehi_db/ --pg1-port=5432 --pg2-port=5432 --pg3-port=5432 --repo1-cipher-pass=&lt;redacted&gt; --repo1-cipher-type=aes-256-cbc --repo1-path=/var/lib/pgbackrest --stanza=fdi_main
2023-07-12 17:04:42.393 P00   INFO: check repo1 (standby)
2023-07-12 17:04:42.394 P00   INFO: switch wal not performed because this is a standby
2023-07-12 17:04:42.394 P00   INFO: check repo1 configuration (primary)
2023-07-12 17:04:42.596 P00   INFO: check repo1 archive for WAL (primary)
2023-07-12 17:04:43.008 P00   INFO: WAL segment 000001110000052D000000CB successfully archived to &#39;/var/lib/pgbackrest/archive/fdi_main/14-1/000001110000052D/000001110000052D000000CB-4285acb0ced7c37208bad415bbb53f82450b1aa0.gz&#39; on repo1
2023-07-12 17:04:43.309 P00   INFO: check command end: completed successfully (4528ms)
</code></pre></div></p>
<p>Info allows you to check the status of backups and ensure there are recent complete backups of PostgreSQL available in case of a disaster. Here's how you run it:
<div class="highlight"><pre><span></span><code>ubuntu@prod-db-backup01:~$ sudo -u pgbackrest pgbackrest --stanza=fdi_main --log-level-console=info info
stanza: fdi_main
    status: ok
    cipher: aes-256-cbc

    db (current)
        wal archive min/max (14): 0000010500000352000000DD/000001110000052D000000CC

        full backup: 20230618-031405F
            timestamp start/stop: 2023-06-18 03:14:05 / 2023-06-18 03:30:27
            wal start/stop: 0000010500000352000000DD / 0000010500000352000000DD
            database size: 211.9GB, database backup size: 211.9GB
            repo1: backup set size: 61.7GB, backup size: 61.7GB

        full backup: 20230625-031405F
            timestamp start/stop: 2023-06-25 03:14:05 / 2023-06-25 03:29:58
            wal start/stop: 000001080000035A000000C4 / 000001080000035A000000C4
            database size: 213.1GB, database backup size: 213.1GB
            repo1: backup set size: 62GB, backup size: 62GB
</code></pre></div></p>
<h2 id="security-patching">Security &amp; Patching</h2>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tracking", "navigation.instant"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.78eede0e.min.js"></script>
      
    
  </body>
</html>