
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../basics/proxmaas/">
      
      
        <link rel="next" href="../services/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.4">
    
    
      
        <title>Databases - Filecoin Data Infrastructure</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0e669242.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#databases" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Filecoin Data Infrastructure" class="md-header__button md-logo" aria-label="Filecoin Data Infrastructure" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Filecoin Data Infrastructure
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Databases
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../basics/" class="md-tabs__link">
          
  
  Basics

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
    
  
  Databases

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../services/" class="md-tabs__link">
        
  
    
  
  Services

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../kubernetes/" class="md-tabs__link">
        
  
    
  
  Kubernetes

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../rescue/" class="md-tabs__link">
        
  
    
  
  Rescue

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../storage/" class="md-tabs__link">
        
  
    
  
  Storage

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../tls/" class="md-tabs__link">
        
  
    
  
  TLS

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../guides/" class="md-tabs__link">
          
  
  Guides

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Filecoin Data Infrastructure" class="md-nav__button md-logo" aria-label="Filecoin Data Infrastructure" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    Filecoin Data Infrastructure
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Basics
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Basics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../basics/proxmaas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ProxMAAS
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Databases
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Databases
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#postgresql-on-kubernetes-phosphophyllite" class="md-nav__link">
    PostgreSQL on Kubernetes (Phosphophyllite)
  </a>
  
    <nav class="md-nav" aria-label="PostgreSQL on Kubernetes (Phosphophyllite)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#listing-postgresql-clusters" class="md-nav__link">
    Listing PostgreSQL clusters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-databases-how-do-i-access-a-database-cluster-on-kubernetes-to-check-on-its-status" class="md-nav__link">
    Accessing databases - how do I access a database cluster on Kubernetes to check on its status?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-databases-how-do-i-use-a-database-within-a-database-cluster" class="md-nav__link">
    Accessing databases - how do I use a database within a database cluster?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deleting-a-postgresql-cluster" class="md-nav__link">
    Deleting a PostgreSQL cluster
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#postgresql-vm-clusters" class="md-nav__link">
    PostgreSQL VM clusters
  </a>
  
    <nav class="md-nav" aria-label="PostgreSQL VM clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#list-of-clusters" class="md-nav__link">
    List of clusters
  </a>
  
    <nav class="md-nav" aria-label="List of clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estuary-hosted-infrastructure-ehi-db" class="md-nav__link">
    Estuary Hosted Infrastructure (EHI) DB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estuary-bootstrap-infrastructure-ebi-db" class="md-nav__link">
    Estuary Bootstrap Infrastructure (EBI) DB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-databases-how-do-i-access-a-database-cluster-to-check-on-its-status" class="md-nav__link">
    Accessing databases - how do I access a database cluster to check on its status?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-databases-how-do-i-use-a-database-in-a-vm-cluster" class="md-nav__link">
    Accessing databases - how do I use a database in a VM cluster?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Services
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../rescue/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rescue
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Storage
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../tls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TLS
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../guides/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../guides/01-diagnosing-pacemaker-clusters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Diagnosing Pacemaker clusters including Prod HAProxy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../guides/02-rebalancing-ceph-osds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ceph: Rebalancing Ceph OSDs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../guides/03-stuck-rook-volumes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes: Fixing stuck Rook.io volumes which are preventing containers from starting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#postgresql-on-kubernetes-phosphophyllite" class="md-nav__link">
    PostgreSQL on Kubernetes (Phosphophyllite)
  </a>
  
    <nav class="md-nav" aria-label="PostgreSQL on Kubernetes (Phosphophyllite)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#listing-postgresql-clusters" class="md-nav__link">
    Listing PostgreSQL clusters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-databases-how-do-i-access-a-database-cluster-on-kubernetes-to-check-on-its-status" class="md-nav__link">
    Accessing databases - how do I access a database cluster on Kubernetes to check on its status?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-databases-how-do-i-use-a-database-within-a-database-cluster" class="md-nav__link">
    Accessing databases - how do I use a database within a database cluster?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deleting-a-postgresql-cluster" class="md-nav__link">
    Deleting a PostgreSQL cluster
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#postgresql-vm-clusters" class="md-nav__link">
    PostgreSQL VM clusters
  </a>
  
    <nav class="md-nav" aria-label="PostgreSQL VM clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#list-of-clusters" class="md-nav__link">
    List of clusters
  </a>
  
    <nav class="md-nav" aria-label="List of clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estuary-hosted-infrastructure-ehi-db" class="md-nav__link">
    Estuary Hosted Infrastructure (EHI) DB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estuary-bootstrap-infrastructure-ebi-db" class="md-nav__link">
    Estuary Bootstrap Infrastructure (EBI) DB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-databases-how-do-i-access-a-database-cluster-to-check-on-its-status" class="md-nav__link">
    Accessing databases - how do I access a database cluster to check on its status?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-databases-how-do-i-use-a-database-in-a-vm-cluster" class="md-nav__link">
    Accessing databases - how do I use a database in a VM cluster?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="databases">Databases</h1>
<h2 id="postgresql-on-kubernetes-phosphophyllite">PostgreSQL on Kubernetes (Phosphophyllite)</h2>
<p>We have various PostgreSQL clusters hosted on Phos k8s, including the most important one - <code>estuary-api</code>. Here's how to examine and manage them.</p>
<h3 id="listing-postgresql-clusters">Listing PostgreSQL clusters</h3>
<p>Once you have <code>kubectl</code> <a href="http://localhost:8000/admin/kubernetes/#getting-kubectl-access">configured and set up for access to <code>phosphophyllite</code></a>, you can access the Postgres Operator UI using kubectl port forwarding. This will give you a view of all PostgreSQL clusters running in Phosphophyllite, as well as the ability to spawn new PostgreSQL clusters if needed.</p>
<p>You can read <a href="https://github.com/zalando/postgres-operator/blob/master/docs/quickstart.md#deploy-the-operator-ui">the quickstart guide for Postgres Operator</a> for more information, but what you probably want is the following one liner:</p>
<ul>
<li><code>kubectl port-forward svc/postgres-operator-ui 8081:80 -n postgres</code></li>
</ul>
<p>Run that in a terminal (<code>screen</code> or <code>tmux</code> if you need it to run for a while) and in your favourite browser, navigate to <a href="http://localhost:8081">http://localhost:8081</a> to open Postgres Operator UI.</p>
<p><img alt="A series of PostgreSQL clusters, displayed in the PostgreSQL Operator UI" src="screen01.png" /></p>
<div class="admonition warning">
<p class="admonition-title">Here be dragons...</p>
<p>Postgres Operator UI will allow you to do lots of potential harm to customer and core PostgreSQL clusters in very short order with very little warning. Please be careful and try to know what you're doing - if you are not sure - ask!</p>
</div>
<p>You will see all the PostgreSQL clusters we operate. You can click Status to check on the status of that particular cluster, Logs to view logs related to that cluster from the perspective of the Postgres Operator (as opposed to the service itself), Clone to create a new cluster from the latest available daily backup, Edit to edit the cluster or Delete to attempt to delete it.</p>
<div class="admonition tip">
<p class="admonition-title">When 'Delete' doesn't mean Delete...</p>
<p>Note that deleting a PostgreSQL cluster is not as easy as clicking that handy "Delete" button. There are delete protections in place that prevent accidental deletions of PostgreSQL clusters, as well as backups that will (eventually) need to be purged when deleting a cluster. For more, see "Deleting clusters" down below.</p>
</div>
<h3 id="accessing-databases-how-do-i-access-a-database-cluster-on-kubernetes-to-check-on-its-status">Accessing databases - how do I access a database cluster on Kubernetes to check on its status?</h3>
<ul>
<li>Open Rancher</li>
<li>Go to the namespace containing the cluster you want to check on.</li>
<li>Find one of the database pods (such as <code>dbfws-0</code>) for the database cluster in question, click the three dots (â‹®) and click <code>&gt; Execute Shell</code> to get a shell inside the container.</li>
<li>Run <code>patronictl list</code> and check that all replicas are on the same timeline (TL) and have no <code>Lag in MB.</code></li>
</ul>
<h3 id="accessing-databases-how-do-i-use-a-database-within-a-database-cluster">Accessing databases - how do I use a database within a database cluster?</h3>
<p>Access to databases requires <code>sslmode=prefer</code> or <code>sslmode=on</code>. <code>sslmode=disable</code> is not supported.</p>
<ul>
<li>Inside Kubernetes: You can access the database using the hostname <code>servicename.namespace</code> - such as <code>dbfws.hivemapper</code> - or just <code>servicename</code> if you are inside the same namespace as that service. Use the standard PostgreSQL port (5432) unless told otherwise.</li>
<li>Outside Kubernetes: To access a database outside Kubernetes, we use <strong>MetalLB</strong> to expose a normal private IP address that can be accessed outside of Kubernetes.</li>
</ul>
<p>In order to access a database outside of Kubernetes, you will need the following settings in the <code>spec</code>:
<div class="highlight"><pre><span></span><code>spec:
  allowedSourceRanges:
    - 10.24.0.0/16 # FDI main private IP space
    - 10.42.0.0/16 # Internal Kubernetes private IP space
  enableMasterLoadBalancer: true
</code></pre></div></p>
<h3 id="deleting-a-postgresql-cluster">Deleting a PostgreSQL cluster</h3>
<p>From time to time you may want or need to delete a database cluster. This may be as a result of a customer leaving or being terminated, or a cluster simply no longer being needed by either the customer or our team.</p>
<div class="admonition danger">
<p class="admonition-title">Tread carefully!</p>
<p>Deleting a PostgreSQL cluster is an irreversible action. Make sure you either have tested and working backups before you proceed, or are 100% sure you do not need the data.</p>
</div>
<p>In order to delete a cluster, you must <em>annotate</em> the PostgreSQL CR with two annotations <code>delete-date</code> and <code>delete-clustername</code>. You can do this either through the Postgres Operator UI or through Rancher.</p>
<p>Create an annotation called <code>delete-date</code> with the date in YYYY-MM-DD format, and an annotation called <code>delete-clustername</code> with the exact name of the cluster as defined in the CR.</p>
<div class="admonition tip">
<p class="admonition-title">CPI is a special case</p>
<p>CPI-deployed PostgreSQL clusters must first be "orphaned" via removal from <code>values.yaml</code> before they can be deleted in this way, and <code>dbfws</code> clusters (the default cluster included for each customer) CANNOT be deleted in this way at all. This is not exactly an intentional choice - Helm does not allow for outside modifications to its resources and will overwrite any changes you make to resources it manages. Thus, your annotations will be overwritten before they take effect.</p>
</div>
<p>Once you have applied the annotations, you may delete the PostgreSQL cluster using any normal means (via Rancher, using <code>kubectl</code> or using the Operator UI).</p>
<p>Deleting clusters does not cleanup or remove their backups. Note that you may cause undesired behaviour (restore from backup) if you create a new cluster with the same exact name and namespace as a previous cluster that was not cleaned up.</p>
<h2 id="postgresql-vm-clusters">PostgreSQL VM clusters</h2>
<p>There are two main PostgreSQL clusters operating outside of Kubernetes. These are powered by a combination of <code>etcd</code>, <code>patroni</code>, <code>postgresql</code> and <code>haproxy</code>.</p>
<h3 id="list-of-clusters">List of clusters</h3>
<ul>
<li>Estuary Hosted Infrastructure (prod-ehi): Hosted on prod-ehi-db[01:03].estuary.tech</li>
<li>Estuary Bootstrap Infrastructure (prod-ebi): Hosted on prod-ebi-db[01:03].estuary.tech</li>
</ul>
<h4 id="estuary-hosted-infrastructure-ehi-db">Estuary Hosted Infrastructure (EHI) DB</h4>
<p>The EHI database cluster runs database services for the following:</p>
<ul>
<li>EstuaryV2: Delta, Delta DM, Edge-UR, Edge-URID</li>
<li>EstuaryV1: Shuttle 12, Edge Carriers,</li>
<li>Gitea</li>
</ul>
<h4 id="estuary-bootstrap-infrastructure-ebi-db">Estuary Bootstrap Infrastructure (EBI) DB</h4>
<p>The EBI database cluster runs database services for the following:</p>
<ul>
<li>AWX automation</li>
<li>Metal as a Service (MAAS) machine deployment</li>
<li>Nautobot</li>
</ul>
<h3 id="accessing-databases-how-do-i-access-a-database-cluster-to-check-on-its-status">Accessing databases - how do I access a database cluster to check on its status?</h3>
<p>SSH into one of the servers that serve the database cluster. Here's an example using EHI:</p>
<p><code>ssh ubuntu@prod-ehi-db01.estuary.tech</code></p>
<p>Elevate to root:</p>
<p><code>sudo su -</code></p>
<p>Use <code>patronictl</code> to list the database members.</p>
<div class="highlight"><pre><span></span><code>root@prod-ehi-db01:~# patronictl -c /etc/patroni/prod-ehi-db01.estuary.tech.yml list
+ Cluster: prod_ehi_db ------+------------+---------+---------+-----+-----------+
| Member                     | Host       | Role    | State   |  TL | Lag in MB |
+----------------------------+------------+---------+---------+-----+-----------+
| prod-ehi-db01.estuary.tech | 10.24.3.20 | Leader  | running | 273 |           |
| prod-ehi-db02.estuary.tech | 10.24.3.21 | Replica | running | 273 |         0 |
| prod-ehi-db03.estuary.tech | 10.24.3.22 | Replica | running | 273 |         0 |
+----------------------------+------------+---------+---------+-----+-----------+
</code></pre></div>
<h3 id="accessing-databases-how-do-i-use-a-database-in-a-vm-cluster">Accessing databases - how do I use a database in a VM cluster?</h3>
<p>You can access the databases in the VM clusters using <code>postgres-ehi.estuary.tech</code> and <code>postgres-ebi.estuary.tech</code> (both are CNAMEs which point at the production HAProxies).</p>
<p>The chosen TCP port is what determines which PostgreSQL cluster you connect to - 51432 for EBI, 52432 for EHI.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tracking", "navigation.instant"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.78eede0e.min.js"></script>
      
    
  </body>
</html>